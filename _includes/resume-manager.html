<!-- Resume functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // Resume functionality
    class ResumeManager {
        constructor() {
            this.resumeApiUrl = '{{ site.resume_repo }}';
            this.resumeContent = null;
            this.setupEventListeners();
            this.loadResumeContent();
        }

        setupEventListeners() {
            const downloadBtn = document.getElementById('download-pdf-link');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadPDF();
                });
            }
        }

        async loadResumeContent() {
            const resumeMarkdown = await this.fetchResumeContent();
            if (resumeMarkdown) {
                this.resumeContent = resumeMarkdown;
                this.displayResumeContent(resumeMarkdown);
            } else {
                this.showError();
            }
        }

        displayResumeContent(markdown) {
            const contentDiv = document.getElementById('resume-content');
            if (contentDiv) {
                contentDiv.innerHTML = this.markdownToHtml(markdown);
            }
        }

        showError() {
            const contentDiv = document.getElementById('resume-content');
            if (contentDiv) {
                contentDiv.innerHTML = '<p class="text-center" style="color: var(--danger-color, #e74c3c);"><i class="fa-solid fa-exclamation-triangle"></i> Unable to load resume content. Please try again later.</p>';
            }
        }

        async fetchResumeContent() {
            try {
                console.log('Fetching resume from:', this.resumeApiUrl);
                const response = await fetch(this.resumeApiUrl);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Resume data received:', data);
                
                if (!data.content) {
                    throw new Error('No content field in response');
                }
                
                const content = atob(data.content); // Decode base64 content
                console.log('Decoded content length:', content.length);
                return content;
            } catch (error) {
                console.error('Error fetching resume:', error);
                console.error('Resume API URL was:', this.resumeApiUrl);
                return null;
            }
        }

        async downloadPDF() {
            if (this.resumeContent) {
                // Create a clean container for PDF generation
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = this.markdownToHtml(this.resumeContent);
                tempDiv.style.cssText = 'padding: 30px; font-family: Georgia, serif; line-height: 1.6; color: #333; background: white; max-width: none;';
                
                // Add some styling for PDF
                const style = document.createElement('style');
                style.textContent = `
                    h1 { font-size: 24px; margin-bottom: 10px; border-bottom: 2px solid #333; padding-bottom: 5px; }
                    h2 { font-size: 20px; margin: 20px 0 10px 0; color: #555; }
                    h3 { font-size: 16px; margin: 15px 0 5px 0; color: #666; }
                    ul { margin: 10px 0; padding-left: 20px; }
                    li { margin: 5px 0; }
                    p { margin: 8px 0; }
                `;
                tempDiv.appendChild(style);
                
                html2pdf().from(tempDiv).set({
                    margin: 0.5,
                    filename: 'diego-barros-resume.pdf',
                    html2canvas: { scale: 1.5, useCORS: true },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                }).save();
            } else {
                alert('Resume content not loaded yet. Please try again in a moment.');
            }
        }

        markdownToHtml(markdown) {
            // Enhanced markdown to HTML conversion
            let html = markdown
                // Remove any leading/trailing whitespace
                .trim()
                // Headers (must be at start of line)
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                // Code blocks (simple)
                .replace(/`([^`]+)`/gim, '<code>$1</code>')
                // Horizontal rules
                .replace(/^---$/gim, '<hr>')
                // Lists (unordered)
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                // Lists (ordered)
                .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');

            // Convert double line breaks to paragraph breaks
            html = html.replace(/\n\n/g, '</p><p>');
            
            // Convert remaining single line breaks to <br>
            html = html.replace(/\n/g, '<br>');
            
            // Wrap in paragraphs
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            
            // Wrap consecutive list items in ul tags
            html = html.replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/gims, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Clean up paragraphs around headers
            html = html.replace(/<p>(<h[1-6]>.*?<\/h[1-6]>)<\/p>/gim, '$1');
            
            // Clean up paragraphs around lists
            html = html.replace(/<p>(<ul>.*?<\/ul>)<\/p>/gims, '$1');
            
            // Clean up paragraphs around hrs
            html = html.replace(/<p>(<hr[^>]*>)<\/p>/gim, '$1');

            return html;
        }
    }

    // Initialize resume manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        new ResumeManager();
    });
</script>